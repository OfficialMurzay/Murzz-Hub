--------------------------------------------------
-- SERVICES
--------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

--------------------------------------------------
-- LOAD RAYFIELD (LOADING ANIMATION)
--------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "MurzzHub v1.0",
    LoadingTitle = "MurzzHub v1.0",
    LoadingSubtitle = "Auto Train â€¢ Teleports â€¢ Quests",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

--------------------------------------------------
-- COMMON HELPERS
--------------------------------------------------
local function formatNumber(n)
    n = tonumber(n) or 0
    local units = {
        {1e15,"Qd"},{1e12,"T"},{1e9,"B"},
        {1e6,"M"},{1e3,"K"}
    }
    for _,u in ipairs(units) do
        if n >= u[1] then
            return string.format("%.2f%s", n/u[1], u[2]):gsub("%.00","")
        end
    end
    return tostring(n)
end

--------------------------------------------------
-- STAT MAPS
--------------------------------------------------
local StatMap = {
    [1] = "Strength",
    [2] = "Durability",
    [3] = "Chakra",
    [4] = "Sword",
    [5] = "Agility",
    [6] = "Speed"
}

local StatEmojis = {
    Strength = "ğŸ’ª",
    Durability = "ğŸ›¡ï¸",
    Chakra = "ğŸŒ€",
    Sword = "ğŸ—¡ï¸",
    Speed = "ğŸ’¨",
    Agility = "â˜ï¸"
}

local StatColors = {
    Strength   = Color3.fromRGB(255, 80, 80),
    Durability = Color3.fromRGB(80, 160, 255),
    Chakra     = Color3.fromRGB(180, 90, 255),
    Sword      = Color3.fromRGB(80, 200, 120),
    Agility    = Color3.fromRGB(255, 220, 80),
    Speed      = Color3.fromRGB(255, 160, 80)
}

--------------------------------------------------
-- HOME TAB
--------------------------------------------------
local HomeTab = Window:CreateTab("Home ğŸ ")

HomeTab:CreateSection("Player Data ğŸ‘¤")

local ClassLabel = HomeTab:CreateLabel("Class: Loading...")
local PowerLabel = HomeTab:CreateLabel("Total Power: Loading âš¡")
local YenLabel = HomeTab:CreateLabel("Yen: Loading ğŸ’°")
local ChakraLabel = HomeTab:CreateLabel("Chakra: Loading ğŸ’")

HomeTab:CreateSection("Live Stats ğŸ“Š")

local StatLabels = {
    Strength   = HomeTab:CreateLabel("Strength: ... ğŸ’ª"),
    Durability = HomeTab:CreateLabel("Durability: ... ğŸ›¡ï¸"),
    Chakra     = HomeTab:CreateLabel("Chakra: ... ğŸŒ€"),
    Sword      = HomeTab:CreateLabel("Sword: ... ğŸ—¡ï¸"),
    Speed      = HomeTab:CreateLabel("Speed: ... ğŸ’¨"),
    Agility    = HomeTab:CreateLabel("Agility: ... â˜ï¸")
}

--------------------------------------------------
-- HOME LIVE UPDATE
--------------------------------------------------
RunService.Heartbeat:Connect(function()
    local stats = player:FindFirstChild("Stats")
    local other = player:FindFirstChild("OtherData")
    if not stats or not other then return end

    -- Player data
    local totalPower = other:FindFirstChild("TotalPower")
    local yen = other:FindFirstChild("Yen")
    local chakra = other:FindFirstChild("Chikara")

    if totalPower then
        PowerLabel:Set("Total Power: "..formatNumber(totalPower.Value).." âš¡")
    end
    if yen then
        YenLabel:Set("Yen: "..formatNumber(yen.Value).." ğŸ’°")
    end
    if chakra then
        ChakraLabel:Set("Chakra: "..formatNumber(chakra.Value).." ğŸ’")
    end

    -- Stats
    for id,name in pairs(StatMap) do
        local stat = stats:FindFirstChild(tostring(id))
        if stat and StatLabels[name] then
            StatLabels[name]:Set(
                name..": "..formatNumber(stat.Value).." "..StatEmojis[name]
            )
        end
    end
end)

--------------------------------------------------
-- QUEST TAB
--------------------------------------------------
local QuestTab = Window:CreateTab("Quests ğŸ“œ")
local QuestsFolder = player:WaitForChild("Quests")

local ActiveQuest = nil
local Bars = {}
local UpdateConnection = nil
local CompleteLabel = nil

--------------------------------------------------
-- CLEAN QUEST UI
--------------------------------------------------
local function clearQuestUI()
    if UpdateConnection then
        UpdateConnection:Disconnect()
        UpdateConnection = nil
    end
    for _,b in pairs(Bars) do
        b.Bar:Destroy()
    end
    Bars = {}
    if CompleteLabel then
        CompleteLabel:Destroy()
        CompleteLabel = nil
    end
    QuestTab:Clear()
end

--------------------------------------------------
-- QUEST COMPLETE ANIMATION
--------------------------------------------------
local function playCompletion()
    CompleteLabel = QuestTab:CreateLabel("âœ… QUEST COMPLETE!")
    task.delay(2, function()
        if CompleteLabel then
            CompleteLabel:Destroy()
            CompleteLabel = nil
        end
    end)
end

--------------------------------------------------
-- BUILD QUEST UI
--------------------------------------------------
local function buildQuestUI(quest)
    clearQuestUI()
    ActiveQuest = quest

    QuestTab:CreateSection("Quest: "..quest.Name.." ğŸ§¾")

    local progress = quest:FindFirstChild("Progress")
    local requirements = quest:FindFirstChild("Requirements")
    if not progress or not requirements then return end

    local completed = false

    for _,p in ipairs(progress:GetChildren()) do
        if not p:IsA("IntValue") then continue end

        local statId = tonumber(p.Name)
        local statName = StatMap[statId]
        local req = requirements:FindFirstChild(p.Name)
        if not statName or not req then continue end

        local bar = QuestTab:CreateSlider({
            Name = statName,
            Range = {0,100},
            Increment = 1,
            Suffix = "%",
            CurrentValue = 0,
            Callback = function() end
        })

        Bars[p] = { Bar = bar, Req = req, Name = statName }

        task.spawn(function()
            task.wait()
            if bar.Container and bar.Container:FindFirstChild("Fill") then
                bar.Container.Fill.BackgroundColor3 = StatColors[statName]
            end
        end)
    end

    UpdateConnection = RunService.Heartbeat:Connect(function()
        if not quest.Parent then return end

        local allDone = true
        for p,data in pairs(Bars) do
            if not p.Parent then continue end
            local percent = math.clamp(p.Value / data.Req.Value, 0, 1)
            data.Bar:Set({
                Name = data.Name.."  "..formatNumber(p.Value).."/"..formatNumber(data.Req.Value),
                CurrentValue = math.floor(percent * 100)
            })
            if p.Value < data.Req.Value then
                allDone = false
            end
        end

        if allDone and not completed then
            completed = true
            playCompletion()
        end
    end)
end

--------------------------------------------------
-- QUEST WATCHER (AUTO SWITCH)
--------------------------------------------------
task.spawn(function()
    local lastQuest = nil
    while true do
        local current = nil
        for _,q in ipairs(QuestsFolder:GetChildren()) do
            if q:IsA("Folder") and q:FindFirstChild("Progress") and q:FindFirstChild("Requirements") then
                current = q
                break
            end
        end

        if current ~= lastQuest then
            if current then
                buildQuestUI(current)
            else
                clearQuestUI()
                QuestTab:CreateLabel("No active quest âŒ")
            end
            lastQuest = current
        end
        task.wait(0.5)
    end
end)
