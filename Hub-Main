-- MurzzHub v1.0ae Beta (Fixed Label Creation Per Section)
-- Author: Murzay (Modified by ChatGPT)

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer
local OtherData = Player:WaitForChild("OtherData")
local StatsFolder = Player:WaitForChild("Stats")
local QuestsFolder = Player:WaitForChild("Quests")

-------------------------------------------------
-- VERSION
-------------------------------------------------
local VERSION = "v1.0ae Beta"

-------------------------------------------------
-- DEBUG
-------------------------------------------------
local debugErrorShown = false
local function safeRun(func)
    local ok, err = pcall(func)
    if not ok and not debugErrorShown then
        debugErrorShown = true
        warn("[MurzzHub Debug] An error occurred:\n"..tostring(err))
    end
end

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local Window = Rayfield:CreateWindow({
    Name = "MurzzHub "..VERSION,
    LoadingTitle = "MurzzHub "..VERSION,
    LoadingSubtitle = VERSION.." - UI Live Player Data, Stats & Quests",
    ConfigurationSaving = {Enabled=true, FolderName="MurzzHub", FileName="AFSE_UI"},
    KeySystem = false
})

-------------------------------------------------
-- UTILITIES
-------------------------------------------------
local function abbreviateNumber(num)
    if not num then return "0" end
    local absNum = math.abs(num)
    if absNum >= 1e21 then return string.format("%.2fSx", num/1e21)
    elseif absNum >= 1e18 then return string.format("%.2fQn", num/1e18)
    elseif absNum >= 1e15 then return string.format("%.2fQd", num/1e15)
    elseif absNum >= 1e12 then return string.format("%.2fT", num/1e12)
    elseif absNum >= 1e9 then return string.format("%.2fB", num/1e9)
    elseif absNum >= 1e6 then return string.format("%.2fM", num/1e6)
    elseif absNum >= 1e3 then return string.format("%.2fK", num/1e3)
    else return tostring(num) end
end

local function animateValue(label, startVal, endVal, prefix, emoji, duration)
    if startVal == endVal or not label then return end
    local step = (endVal - startVal)/(duration*30)
    local current = startVal
    local connection
    connection = RunService.RenderStepped:Connect(function()
        current = current + step
        if (step > 0 and current >= endVal) or (step < 0 and current <= endVal) then
            current = endVal
            connection:Disconnect()
        end
        if label and label.Set then
            label:Set(tostring(prefix or "")..abbreviateNumber(math.floor(current)).." "..tostring(emoji or ""))
        elseif label and label.Text ~= nil then
            label.Text = tostring(prefix or "")..abbreviateNumber(math.floor(current)).." "..tostring(emoji or "")
        end
    end)
end

-------------------------------------------------
-- CLASS MAP
-------------------------------------------------
local ClassMap = {
    [1]="Fighter ü•ä",[2]="Shinobi üåÄ",[3]="Pirate ‚ò†Ô∏è",[4]="Ghoul üëª",[5]="Hero ü¶∏",
    [6]="Reaper ‚ò†Ô∏è",[7]="Saiyan üí•",[8]="Sin üòà",[9]="Magi üßô",[10]="Akuma üò°",
    [11]="Yonko üè¥‚Äç‚ò†Ô∏è",[12]="Gorosei üßì",[13]="Overlord üëë",[14]="Hokage ü¶ä",
    [15]="Kaioshin üëº",[16]="Sage üïäÔ∏è",[17]="Espada ‚öîÔ∏è",[18]="Shinigami üëπ",
    [19]="Hashira ‚öîÔ∏è",[20]="Hakaishin üíÄ",[21]="Otsutsuki üåå",
    [22]="Pirate King üè¥‚Äç‚ò†Ô∏èüëë",[23]="Kishin üëø",[24]="Angel üòá",
    [25]="Demon King üëπ",[26]="Ultra Instinct ‚ú®",[27]="Upper Moon üåô"
}

-------------------------------------------------
-- STAT MAP
-------------------------------------------------
local StatIdToName = {
    [1]="Strength üí™",[2]="Durability üõ°Ô∏è",[3]="Chakra üåÄ",[4]="Sword üó°Ô∏è",[5]="Speed üí®",[6]="Agility ‚òÅÔ∏è"
}

-------------------------------------------------
-- INFO TAB
-------------------------------------------------
local InfoTab = Window:CreateTab("Info üõ†Ô∏è")
InfoTab:CreateSection("Update Log üìù")
InfoTab:CreateParagraph({Title="MurzzHub "..VERSION.." Update Log", Content=[[
‚Ä¢ Quest tab now uses proper sections
‚Ä¢ Requirements displayed as child labels under each section
‚Ä¢ Progress updates live with animation
‚Ä¢ Info tab restored with Dear @username & Discord button
‚Ä¢ Optimized and nil-safe
]]})

InfoTab:CreateSection("Discord üí¨")
InfoTab:CreateParagraph({
    Title = "Dear @"..tostring(Player.DisplayName or "Player"),
    Content = [[
Thank you for using my script! Every use really supports me and gives me motivation to continue updating this script!
If you have any suggestions or want sneak peeks, events, and more, join the Discord Server! ‚ù§Ô∏è - Murzay
]]
})
InfoTab:CreateButton({
    Name = "Join The Discord Server!",
    Callback = function()
        safeRun(function()
            local discordLink = "DISCORD_LINK_HERE"
            if discordLink and discordLink ~= "" then
                if syn and syn.request then
                    syn.request({Url=discordLink})
                else
                    setclipboard(discordLink)
                end
            end
        end)
    end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home üè†")
HomeTab:CreateSection("Player Data üë§")
local ClassLabel = HomeTab:CreateLabel("Class: ...")
local PowerLabel = HomeTab:CreateLabel("Total Power: ... ‚ö°")
local YenLabel = HomeTab:CreateLabel("Money: ... üí∞")
local ChikaraLabel = HomeTab:CreateLabel("Chikara: ... üíé")

HomeTab:CreateSection("Live Stats üìä")
local LiveStats = {}
for statId,name in pairs(StatIdToName) do
    local statName, emoji = name:match("^(.-) (.+)$")
    LiveStats[statId] = {Label=HomeTab:CreateLabel(statName..": ... "..emoji), Value=0, Emoji=emoji, StatName=statName}
end

-------------------------------------------------
-- QUESTS TAB
-------------------------------------------------
local QuestsTab = Window:CreateTab("Quests üìú")
local QuestSections = {}
local QuestLabels = {}
local AnimatedQuestValues = {}

local function getAnimatedValue(questFolder, reqName)
    AnimatedQuestValues[questFolder] = AnimatedQuestValues[questFolder] or {}
    if AnimatedQuestValues[questFolder][reqName] == nil then
        AnimatedQuestValues[questFolder][reqName] = 0
    end
    return AnimatedQuestValues[questFolder][reqName]
end

local function createOrUpdateQuestSection(questFolder)
    safeRun(function()
        if not questFolder then return end
        local displayName = questFolder.Name
        local emoji = "üìå"
        local name, number = displayName:match("(%a+)(%d+)")
        if name and number then displayName = name.." No."..number end

        -- Create section only once
        if not QuestSections[questFolder.Name] then
            QuestSections[questFolder.Name] = QuestsTab:CreateSection(emoji.." "..displayName)
            QuestLabels[questFolder.Name] = {}
        end
        local section = QuestSections[questFolder.Name]

        local Requirements = questFolder:FindFirstChild("Requirements")
        if not Requirements then return end
        local ProgressFolder = questFolder:FindFirstChild("Progress")

        for _, req in ipairs(Requirements:GetChildren()) do
            if req:IsA("IntValue") or req:IsA("NumberValue") then
                local progVal = 0
                if ProgressFolder then
                    local prog = ProgressFolder:FindFirstChild(req.Name)
                    if prog then progVal = prog.Value end
                else
                    local prog = questFolder:FindFirstChild(req.Name)
                    if prog then progVal = prog.Value end
                end

                local animVal = getAnimatedValue(questFolder, req.Name)
                animateValue({Set=function(v) AnimatedQuestValues[questFolder][req.Name]=v end}, animVal, progVal, 0, "", 0.5)

                local statName, emojiStat
                local numId = tonumber(req.Name)
                if numId and StatIdToName[numId] then
                    local fullName = StatIdToName[numId]
                    statName, emojiStat = fullName:match("^(.-) (.+)$")
                else
                    statName = tostring(req.Name or "")
                    emojiStat = ""
                end

                local complete = progVal >= req.Value
                local labelText = string.format("%s/%s %s %s%s",
                    abbreviateNumber(progVal),
                    abbreviateNumber(req.Value),
                    tostring(statName),
                    tostring(emojiStat),
                    complete and " ‚úÖ" or ""
                )

                if not QuestLabels[questFolder.Name][req.Name] then
                    QuestLabels[questFolder.Name][req.Name] = section:CreateLabel(labelText)
                else
                    local lbl = QuestLabels[questFolder.Name][req.Name]
                    if lbl and lbl.Set then
                        lbl:Set(labelText)
                    elseif lbl and lbl.Text ~= nil then
                        lbl.Text = labelText
                    end
                end
            end
        end
    end)
end

for _, q in ipairs(QuestsFolder:GetChildren()) do createOrUpdateQuestSection(q) end
QuestsFolder.ChildAdded:Connect(function(child)
    if child:IsA("Folder") then createOrUpdateQuestSection(child) end
end)

-------------------------------------------------
-- HEARTBEAT LOOP
-------------------------------------------------
RunService.Heartbeat:Connect(function()
    safeRun(function()
        -- Player Data
        if OtherData:FindFirstChild("Class") then
            ClassLabel:Set("Class: "..(ClassMap[OtherData.Class.Value] or "Unknown ‚ùì"))
        end
        if OtherData:FindFirstChild("TotalPower") then
            animateValue(PowerLabel,PowerLabel.Value or 0,OtherData.TotalPower.Value,"Total Power: ","‚ö°",0.5)
        end
        if OtherData:FindFirstChild("Yen") then
            animateValue(YenLabel,YenLabel.Value or 0,OtherData.Yen.Value,"Money: ","üí∞",0.5)
        end
        if OtherData:FindFirstChild("Chikara") then
            animateValue(ChikaraLabel,ChikaraLabel.Value or 0,OtherData.Chikara.Value,"Chikara: ","üíé",0.5)
        end

        -- Live Stats
        for statId,data in pairs(LiveStats) do
            local statObj = StatsFolder:FindFirstChild(tostring(statId))
            if statObj and statObj.Value ~= data.Value then
                animateValue(data.Label,data.Value,statObj.Value,data.StatName..": ",data.Emoji,0.5)
                data.Value = statObj.Value
            end
        end

        -- Live Quests
        for _, q in ipairs(QuestsFolder:GetChildren()) do createOrUpdateQuestSection(q) end
    end)
end)

-------------------------------------------------
-- DONE
-------------------------------------------------
Rayfield:LoadConfiguration()
print("[MurzzHub] v1.0ae Beta loaded successfully - Quest sections and live labels functional")
