-- MurzzHub v1.0p Beta (UI + Player Data, Stats & Quest Overview + Info Tab + Quests Tab)
-- Author: Murzay (Modified by ChatGPT)
-- VERSION NOTE: v1.0o -> v1.0p

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local OtherData = Player:WaitForChild("OtherData")
local StatsFolder = Player:WaitForChild("Stats")
local QuestsFolder = Player:WaitForChild("Quests")

-------------------------------------------------
-- VERSION
-------------------------------------------------
local VERSION = "v1.0p Beta"

-------------------------------------------------
-- DEBUG SYSTEM
-------------------------------------------------
local debugErrorShown = false
local function safeRun(func)
    local ok, err = pcall(func)
    if not ok and not debugErrorShown then
        debugErrorShown = true
        warn("[MurzzHub Debug] An error occurred:\n"..err)
    end
end

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local Window = Rayfield:CreateWindow({
    Name = "MurzzHub "..VERSION,
    LoadingTitle = "MurzzHub "..VERSION,
    LoadingSubtitle = VERSION.." - UI Live Player Data, Stats & Quests",
    ConfigurationSaving = { Enabled=true, FolderName="MurzzHub", FileName="AFSE_UI" },
    KeySystem = false
})

-------------------------------------------------
-- UTILITIES
-------------------------------------------------
local function abbreviateNumber(num)
    if not num then return "0" end
    local absNum = math.abs(num)
    if absNum >= 1e21 then return string.format("%.2fSx", num/1e21)
    elseif absNum >= 1e18 then return string.format("%.2fQn", num/1e18)
    elseif absNum >= 1e15 then return string.format("%.2fQd", num/1e15)
    elseif absNum >= 1e12 then return string.format("%.2fT", num/1e12)
    elseif absNum >= 1e9 then return string.format("%.2fB", num/1e9)
    elseif absNum >= 1e6 then return string.format("%.2fM", num/1e6)
    elseif absNum >= 1e3 then return string.format("%.2fK", num/1e3)
    else return tostring(num) end
end

-------------------------------------------------
-- CLASS MAP
-------------------------------------------------
local ClassMap = {
    [1]="Fighter ü•ä",[2]="Shinobi üåÄ",[3]="Pirate ‚ò†Ô∏è",[4]="Ghoul üëª",[5]="Hero ü¶∏",
    [6]="Reaper ‚ò†Ô∏è",[7]="Saiyan üí•",[8]="Sin üòà",[9]="Magi üßô",[10]="Akuma üò°",
    [11]="Yonko üè¥‚Äç‚ò†Ô∏è",[12]="Gorosei üßì",[13]="Overlord üëë",[14]="Hokage ü¶ä",
    [15]="Kaioshin üëº",[16]="Sage üïäÔ∏è",[17]="Espada ‚öîÔ∏è",[18]="Shinigami üëπ",
    [19]="Hashira ‚öîÔ∏è",[20]="Hakaishin üíÄ",[21]="Otsutsuki üåå",
    [22]="Pirate King üè¥‚Äç‚ò†Ô∏èüëë",[23]="Kishin üëø",[24]="Angel üòá",
    [25]="Demon King üëπ",[26]="Ultra Instinct ‚ú®",[27]="Upper Moon üåô"
}

-------------------------------------------------
-- STAT MAP
-------------------------------------------------
local StatIdToName = {
    [1]="Strength üí™",[2]="Durability üõ°Ô∏è",[3]="Chakra üåÄ",[4]="Sword üó°Ô∏è",[5]="Speed üí®",[6]="Agility ‚òÅÔ∏è"
}

-------------------------------------------------
-- INFO TAB
-------------------------------------------------
local InfoTab = Window:CreateTab("Info üõ†Ô∏è")
InfoTab:CreateSection("Update Log üìù")
InfoTab:CreateParagraph({
    Title = "Update Log "..VERSION..": Quests Tab üìù",
    Content = "Added efficient event-based Home tab Quest Overview, live stat progress, abbreviated numbers, completion notifications, and fixed Info tab layout."
})
InfoTab:CreateSection("Discord üí¨")
InfoTab:CreateParagraph({
    Title = "Dear @"..Player.DisplayName,
    Content = [[
Thank you for using my script! Every use really supports me, and gives me motivation to continue updating this script!
If you have any suggestions, or just want to see sneak peaks, events and more then join the Discord Server! ‚ù§Ô∏è - Murzay (Scripter)
]]
})
InfoTab:CreateButton({
    Name = "Join The Discord Server!",
    Callback = function()
        safeRun(function()
            local discordLink = "DISCORD_LINK_HERE"
            if discordLink and discordLink ~= "" then
                if syn and syn.request then
                    syn.request({Url=discordLink})
                else
                    setclipboard(discordLink)
                end
            end
        end)
    end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home üè†")
HomeTab:CreateSection("Player Data üë§")
local ClassLabel = HomeTab:CreateLabel("Class: ...")
local PowerLabel = HomeTab:CreateLabel("Total Power: ... ‚ö°")
local YenLabel = HomeTab:CreateLabel("Money: ... üí∞")
local ChikaraLabel = HomeTab:CreateLabel("Chikara: ... üíé")

HomeTab:CreateSection("Live Stats üìä")
local LiveStats = {}
for statId,name in pairs(StatIdToName) do
    local statName, emoji = name:match("^(.-) (.+)$")
    LiveStats[statId] = {Label=HomeTab:CreateLabel(statName..": ... "..emoji), Value=0, Emoji=emoji, StatName=statName}
end

-- HOME TAB QUEST OVERVIEW
HomeTab:CreateSection("Quest Overview üìú")
local QuestOverviewLabels = {}

local function updateQuestOverview(questFolder)
    safeRun(function()
        if not questFolder then return end
        local labelData = QuestOverviewLabels[questFolder.Name]
        if not labelData then
            -- Create new label if missing
            local displayName = questFolder.Name
            local name, number = displayName:match("(%a+)(%d+)")
            if name and number then displayName = name.." No."..number end
            local label = HomeTab:CreateLabel(displayName.." [0%]")
            QuestOverviewLabels[questFolder.Name] = {Label=label}
            labelData = QuestOverviewLabels[questFolder.Name]
        end

        local Requirements = questFolder:FindFirstChild("Requirements")
        local Progress = questFolder:FindFirstChild("Progress")
        if not Requirements or not Progress then return end

        local totalReq, totalProg = 0, 0
        for _, req in ipairs(Requirements:GetChildren()) do
            if req:IsA("IntValue") or req:IsA("NumberValue") then
                totalReq = totalReq + req.Value
                local progObj = Progress:FindFirstChild(req.Name)
                if progObj and (progObj:IsA("IntValue") or progObj:IsA("NumberValue")) then
                    totalProg = totalProg + progObj.Value
                end
            end
        end
        local percentage = totalReq > 0 and math.floor((totalProg / totalReq)*100) or 0
        if labelData.Label and labelData.Label.Set then
            labelData.Label:Set(displayName.." ["..percentage.."%]")
        end
    end)
end

-- Setup event-based updates for Home Quest Overview
local function hookQuestFolderEvents(questFolder)
    updateQuestOverview(questFolder)
    local Requirements = questFolder:FindFirstChild("Requirements")
    local Progress = questFolder:FindFirstChild("Progress")
    if Requirements then
        Requirements.ChildAdded:Connect(function() updateQuestOverview(questFolder) end)
        Requirements.ChildRemoved:Connect(function() updateQuestOverview(questFolder) end)
    end
    if Progress then
        Progress.ChildAdded:Connect(function() updateQuestOverview(questFolder) end)
        Progress.ChildRemoved:Connect(function() updateQuestOverview(questFolder) end)
    end
end

for _, questFolder in ipairs(QuestsFolder:GetChildren()) do
    if questFolder:IsA("Folder") then hookQuestFolderEvents(questFolder) end
end

QuestsFolder.ChildAdded:Connect(function(child)
    if child:IsA("Folder") then hookQuestFolderEvents(child) end
end)

-------------------------------------------------
-- QUESTS TAB
-------------------------------------------------
local QuestsTab = Window:CreateTab("Quests üìú")
QuestsTab:CreateSection("Current Quests üìå")
local QuestParagraphs = {}

local function updateQuestParagraph(questFolder)
    safeRun(function()
        if not questFolder then return end
        local displayName = questFolder.Name
        local name, number = displayName:match("(%a+)(%d+)")
        if name and number then displayName = name.." No."..number end

        local Requirements = questFolder:FindFirstChild("Requirements")
        local Progress = questFolder:FindFirstChild("Progress")
        if not Requirements or not Progress then return end

        local descLines = {}
        local allComplete = true
        for _, req in ipairs(Requirements:GetChildren()) do
            if req:IsA("IntValue") or req:IsA("NumberValue") then
                local prog = Progress:FindFirstChild(req.Name)
                local progVal = 0
                if prog and (prog:IsA("IntValue") or prog:IsA("NumberValue")) then progVal = prog.Value end
                local statComplete = progVal >= req.Value
                if not statComplete then allComplete=false end
                local line = string.format("%s/%s %s%s", abbreviateNumber(progVal), abbreviateNumber(req.Value), req.Name, statComplete and " ‚úÖ" or "")
                table.insert(descLines,line)
            end
        end
        local descText = table.concat(descLines,"\n")
        local titleText = displayName..(allComplete and " ‚úÖ" or "")

        if not QuestParagraphs[questFolder.Name] then
            local paragraph = QuestsTab:CreateParagraph({Title=titleText, Content=descText})
            QuestParagraphs[questFolder.Name] = paragraph
            paragraph.Completed = allComplete
        else
            local paragraph = QuestParagraphs[questFolder.Name]
            if paragraph and paragraph.Set then paragraph:Set(descText) end
            if paragraph then paragraph.Title = titleText end
            paragraph.Completed = allComplete
        end

        if allComplete then
            local paragraph = QuestParagraphs[questFolder.Name]
            if paragraph and not paragraph.Notified then
                paragraph.Notified = true
                Rayfield:Notify({
                    Title="‚úÖ You completed a quest!",
                    Content="You completed "..displayName.."! Stay on that grinding streak!",
                    Duration=5,
                    Image=1580567251
                })
            end
        end
    end)
end

for _,questFolder in ipairs(QuestsFolder:GetChildren()) do updateQuestParagraph(questFolder) end
QuestsFolder.ChildAdded:Connect(function(child) if child:IsA("Folder") then updateQuestParagraph(child) end end)

-------------------------------------------------
-- PLAYER DATA & STATS LIVE UPDATE
-------------------------------------------------
local currentPower,currentYen,currentChikara = 0,0,0
local function updatePlayerStats()
    safeRun(function()
        if OtherData:FindFirstChild("Class") then
            ClassLabel:Set("Class: "..(ClassMap[OtherData.Class.Value] or "Unknown ‚ùì"))
        end
        if OtherData:FindFirstChild("TotalPower") then
            local target = OtherData.TotalPower.Value
            PowerLabel:Set("Total Power: "..abbreviateNumber(target).." ‚ö°")
            currentPower = target
        end
        if OtherData:FindFirstChild("Yen") then
            local target = OtherData.Yen.Value
            YenLabel:Set("Money: "..abbreviateNumber(target).." üí∞")
            currentYen = target
        end
        if OtherData:FindFirstChild("Chikara") then
            local target = OtherData.Chikara.Value
            ChikaraLabel:Set("Chikara: "..abbreviateNumber(target).." üíé")
            currentChikara = target
        end

        for statId,data in pairs(LiveStats) do
            local statObj = StatsFolder:FindFirstChild(tostring(statId))
            if statObj and statObj.Value ~= data.Value then
                data.Label:Set(data.StatName..": "..abbreviateNumber(statObj.Value).." "..data.Emoji)
                data.Value = statObj.Value
            end
        end
    end)
end

-- Event-based updates for player stats
OtherData.ChildChanged:Connect(updatePlayerStats)
StatsFolder.ChildChanged:Connect(updatePlayerStats)

-------------------------------------------------
-- DONE
-------------------------------------------------
Rayfield:LoadConfiguration()
updatePlayerStats()
print("[MurzzHub] Fully loaded "..VERSION.." with Home tab Quest Overview and event-based updates")
