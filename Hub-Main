-- MurzzHub v1.0t Beta
-- Rayfield-safe quest refresh
-- NO DestroyTab usage
-- Author: Murzay

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local Player = Players.LocalPlayer

local OtherData = Player:WaitForChild("OtherData")
local StatsFolder = Player:WaitForChild("Stats")
local QuestsFolder = Player:WaitForChild("Quests")

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "MurzzHub v1.0t Beta",
    LoadingTitle = "MurzzHub",
    LoadingSubtitle = "Stable Build",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "MurzzHub",
        FileName = "AFSE_UI"
    }
})

-------------------------------------------------
-- UTIL
-------------------------------------------------
local function abbreviate(n)
    if n >= 1e18 then return string.format("%.2fQn", n/1e18)
    elseif n >= 1e15 then return string.format("%.2fQd", n/1e15)
    elseif n >= 1e12 then return string.format("%.2fT", n/1e12)
    elseif n >= 1e9 then return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then return string.format("%.2fK", n/1e3)
    else return tostring(n) end
end

-------------------------------------------------
-- MAPS (UNCHANGED)
-------------------------------------------------
local StatMap = {
    ["1"]={"Strength","üí™"},
    ["2"]={"Durability","üõ°Ô∏è"},
    ["3"]={"Chakra","üåÄ"},
    ["4"]={"Sword","üó°Ô∏è"},
    ["5"]={"Speed","üí®"},
    ["6"]={"Agility","‚òÅÔ∏è"},
    ["Kill"]={"Kill","üî™"},
}

-------------------------------------------------
-- INFO TAB (ORIGINAL)
-------------------------------------------------
local InfoTab = Window:CreateTab("Info üõ†Ô∏è")

InfoTab:CreateSection("Update Log üìù")
InfoTab:CreateParagraph({
    Title = "v1.0t Beta",
    Content = [[
‚Ä¢ Fixed Rayfield tab deletion crash
‚Ä¢ Quests update on hand-in
‚Ä¢ Overview stays synced
‚Ä¢ Zero loops
]]
})

InfoTab:CreateSection("Message üí¨")
InfoTab:CreateParagraph({
    Title = "Dear @"..Player.DisplayName,
    Content = "Thank you for using MurzzHub ‚ù§Ô∏è"
})

InfoTab:CreateButton({
    Name = "Join Discord",
    Callback = function()
        setclipboard("DISCORD_LINK")
    end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home üè†")

HomeTab:CreateSection("Player Stats üìä")

-------------------------------------------------
-- QUEST OVERVIEW
-------------------------------------------------
HomeTab:CreateSection("Quests Overview üìå")
local OverviewLabels = {}

-------------------------------------------------
-- QUEST TAB
-------------------------------------------------
local QuestsTab = Window:CreateTab("Quests üìú")
local QuestLabels = {}

-------------------------------------------------
-- QUEST REFRESH (SAFE)
-------------------------------------------------
local function refreshQuests()
    -- hide old labels
    for _,lbl in pairs(OverviewLabels) do
        lbl:Set("")
    end
    for _,group in pairs(QuestLabels) do
        for _,lbl in pairs(group) do
            lbl:Set("")
        end
    end

    for _,quest in ipairs(QuestsFolder:GetChildren()) do
        if quest:IsA("Folder") then
            local display = quest.Name:gsub("(%a+)(%d+)", "%1 No.%2")

            -- overview label
            if not OverviewLabels[quest] then
                OverviewLabels[quest] = HomeTab:CreateLabel("")
            end

            local totalReq, totalProg = 0, 0

            local reqs = quest:FindFirstChild("Requirements")
            if reqs then
                for _,req in ipairs(reqs:GetChildren()) do
                    if req:IsA("IntValue") then
                        totalReq += req.Value
                        local prog = 0
                        if quest:FindFirstChild(req.Name) then
                            prog = quest[req.Name].Value
                        end
                        totalProg += math.clamp(prog,0,req.Value)
                    end
                end
            end

            local percent = totalReq > 0 and math.floor((totalProg/totalReq)*100) or 0
            OverviewLabels[quest]:Set(display.." ("..percent.."%)")

            -- quest tab
            if not QuestLabels[quest] then
                QuestLabels[quest] = {}
                QuestsTab:CreateSection(display.." üìú")
            end

            if reqs then
                for _,req in ipairs(reqs:GetChildren()) do
                    if req:IsA("IntValue") then
                        if not QuestLabels[quest][req.Name] then
                            QuestLabels[quest][req.Name] = QuestsTab:CreateLabel("")
                        end

                        local prog = quest:FindFirstChild(req.Name) and quest[req.Name].Value or 0
                        local name, emoji = req.Name, ""
                        if StatMap[req.Name] then
                            name, emoji = unpack(StatMap[req.Name])
                        end

                        QuestLabels[quest][req.Name]:Set(
                            abbreviate(prog).."/"..abbreviate(req.Value)..
                            " "..name.." "..emoji..(prog>=req.Value and " ‚úÖ" or "")
                        )
                    end
                end
            end
        end
    end
end

-------------------------------------------------
-- LIVE QUEST UPDATES
-------------------------------------------------
refreshQuests()

QuestsFolder.ChildAdded:Connect(refreshQuests)
QuestsFolder.ChildRemoved:Connect(refreshQuests)

for _,q in ipairs(QuestsFolder:GetDescendants()) do
    if q:IsA("IntValue") then
        q:GetPropertyChangedSignal("Value"):Connect(refreshQuests)
    end
end

-------------------------------------------------
-- AUTO FARMS
-------------------------------------------------
local AutoTab = Window:CreateTab("Auto Farms ‚öôÔ∏è")
AutoTab:CreateSection("Coming Soon üöß")

-------------------------------------------------
-- DONE
-------------------------------------------------
Rayfield:LoadConfiguration()
print("[MurzzHub] Loaded v1.0t Beta")
