-- MurzzHub v1.0q Beta (UI + Player Data, Stats & Quest Overview + Info Tab + Quests Tab)
-- Author: Murzay (Modified by ChatGPT)
-- VERSION NOTE: v1.0p -> v1.0q

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local OtherData = Player:WaitForChild("OtherData")
local StatsFolder = Player:WaitForChild("Stats")
local QuestsFolder = Player:WaitForChild("Quests")

-------------------------------------------------
-- VERSION
-------------------------------------------------
local VERSION = "v1.0q Beta"

-------------------------------------------------
-- DEBUG SYSTEM
-------------------------------------------------
local debugErrorShown = false
local function safeRun(func)
    local ok, err = pcall(func)
    if not ok and not debugErrorShown then
        debugErrorShown = true
        warn("[MurzzHub Debug] An error occurred:\n"..err)
    end
end

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
local Window = Rayfield:CreateWindow({
    Name = "MurzzHub "..VERSION,
    LoadingTitle = "MurzzHub "..VERSION,
    LoadingSubtitle = VERSION.." - UI Live Player Data, Stats & Quests",
    ConfigurationSaving = { Enabled=true, FolderName="MurzzHub", FileName="AFSE_UI" },
    KeySystem = false
})

-------------------------------------------------
-- UTILITIES
-------------------------------------------------
local function abbreviateNumber(num)
    if not num then return "0" end
    local absNum = math.abs(num)
    if absNum >= 1e21 then return string.format("%.2fSx", num/1e21)
    elseif absNum >= 1e18 then return string.format("%.2fQn", num/1e18)
    elseif absNum >= 1e15 then return string.format("%.2fQd", num/1e15)
    elseif absNum >= 1e12 then return string.format("%.2fT", num/1e12)
    elseif absNum >= 1e9 then return string.format("%.2fB", num/1e9)
    elseif absNum >= 1e6 then return string.format("%.2fM", num/1e6)
    elseif absNum >= 1e3 then return string.format("%.2fK", num/1e3)
    else return tostring(num) end
end

-------------------------------------------------
-- CLASS MAP
-------------------------------------------------
local ClassMap = {
    [1]="Fighter ğŸ¥Š",[2]="Shinobi ğŸŒ€",[3]="Pirate â˜ ï¸",[4]="Ghoul ğŸ‘»",[5]="Hero ğŸ¦¸",
    [6]="Reaper â˜ ï¸",[7]="Saiyan ğŸ’¥",[8]="Sin ğŸ˜ˆ",[9]="Magi ğŸ§™",[10]="Akuma ğŸ˜¡",
    [11]="Yonko ğŸ´â€â˜ ï¸",[12]="Gorosei ğŸ§“",[13]="Overlord ğŸ‘‘",[14]="Hokage ğŸ¦Š",
    [15]="Kaioshin ğŸ‘¼",[16]="Sage ğŸ•Šï¸",[17]="Espada âš”ï¸",[18]="Shinigami ğŸ‘¹",
    [19]="Hashira âš”ï¸",[20]="Hakaishin ğŸ’€",[21]="Otsutsuki ğŸŒŒ",
    [22]="Pirate King ğŸ´â€â˜ ï¸ğŸ‘‘",[23]="Kishin ğŸ‘¿",[24]="Angel ğŸ˜‡",
    [25]="Demon King ğŸ‘¹",[26]="Ultra Instinct âœ¨",[27]="Upper Moon ğŸŒ™"
}

-------------------------------------------------
-- STAT MAP
-------------------------------------------------
local StatIdToName = {
    [1]="Strength ğŸ’ª",[2]="Durability ğŸ›¡ï¸",[3]="Chakra ğŸŒ€",[4]="Sword ğŸ—¡ï¸",[5]="Speed ğŸ’¨",[6]="Agility â˜ï¸"
}

-------------------------------------------------
-- INFO TAB
-------------------------------------------------
local InfoTab = Window:CreateTab("Info ğŸ› ï¸")
InfoTab:CreateSection("Update Log ğŸ“")
InfoTab:CreateParagraph({
    Title = "Update Log "..VERSION..": Quests Tab ğŸ“",
    Content = "Added efficient event-based Home tab Quest Overview, live stat progress, completion ticks, notifications, and Info tab layout fixes."
})
InfoTab:CreateSection("Discord ğŸ’¬")
InfoTab:CreateParagraph({
    Title = "Dear @"..Player.DisplayName,
    Content = [[
Thank you for using my script! Every use really supports me, and gives me motivation to continue updating this script!
If you have any suggestions, or just want to see sneak peaks, events and more then join the Discord Server! â¤ï¸ - Murzay (Scripter)
]]
})
InfoTab:CreateButton({
    Name = "Join The Discord Server!",
    Callback = function()
        safeRun(function()
            local discordLink = "DISCORD_LINK_HERE"
            if discordLink and discordLink ~= "" then
                if syn and syn.request then
                    syn.request({Url=discordLink})
                else
                    setclipboard(discordLink)
                end
            end
        end)
    end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home ğŸ ")
HomeTab:CreateSection("Player Data ğŸ‘¤")
local ClassLabel = HomeTab:CreateLabel("Class: ...")
local PowerLabel = HomeTab:CreateLabel("Total Power: ... âš¡")
local YenLabel = HomeTab:CreateLabel("Money: ... ğŸ’°")
local ChikaraLabel = HomeTab:CreateLabel("Chikara: ... ğŸ’")

-- Live Stats
HomeTab:CreateSection("Live Stats ğŸ“Š")
local LiveStats = {}
for statId,name in pairs(StatIdToName) do
    local statName, emoji = name:match("^(.-) (.+)$")
    LiveStats[statId] = {Label=HomeTab:CreateLabel(statName..": ... "..emoji), Value=0, Emoji=emoji, StatName=statName}
end

-- Quest Overview
HomeTab:CreateSection("Quest Overview ğŸ“œ")
local QuestOverviewLabels = {}

local function updateQuestOverview(questFolder)
    safeRun(function()
        if not questFolder then return end
        local labelData = QuestOverviewLabels[questFolder.Name]
        if not labelData then
            -- Create label
            local displayName = questFolder.Name
            local name, number = displayName:match("(%a+)(%d+)")
            if name and number then displayName = name.." No."..number end
            local label = HomeTab:CreateLabel(displayName.." [0%]")
            QuestOverviewLabels[questFolder.Name] = {Label=label}
            labelData = QuestOverviewLabels[questFolder.Name]
        end

        local Requirements = questFolder:FindFirstChild("Requirements")
        local Progress = questFolder:FindFirstChild("Progress")
        if not Requirements or not Progress then return end

        local totalReq, totalProg = 0, 0
        local allComplete = true
        for _, req in ipairs(Requirements:GetChildren()) do
            if req:IsA("IntValue") or req:IsA("NumberValue") then
                totalReq = totalReq + req.Value
                local progObj = Progress:FindFirstChild(req.Name)
                local progVal = 0
                if progObj and (progObj:IsA("IntValue") or progObj:IsA("NumberValue")) then
                    progVal = progObj.Value
                end
                totalProg = totalProg + progVal
                if progVal < req.Value then allComplete = false end
            end
        end
        local percent = totalReq>0 and math.floor((totalProg/totalReq)*100) or 0
        if labelData.Label and labelData.Label.Set then
            labelData.Label:Set(displayName.." ["..percent.."%]"..(allComplete and " âœ…" or ""))
        end
    end)
end

local function hookQuestEvents(questFolder)
    updateQuestOverview(questFolder)
    local Requirements = questFolder:FindFirstChild("Requirements")
    local Progress = questFolder:FindFirstChild("Progress")
    if Requirements then
        Requirements.ChildAdded:Connect(function() updateQuestOverview(questFolder) end)
        Requirements.ChildRemoved:Connect(function() updateQuestOverview(questFolder) end)
    end
    if Progress then
        Progress.ChildAdded:Connect(function() updateQuestOverview(questFolder) end)
        Progress.ChildRemoved:Connect(function() updateQuestOverview(questFolder) end)
    end
end

for _, q in ipairs(QuestsFolder:GetChildren()) do if q:IsA("Folder") then hookQuestEvents(q) end end
QuestsFolder.ChildAdded:Connect(function(child) if child:IsA("Folder") then hookQuestEvents(child) end end)

-------------------------------------------------
-- QUESTS TAB
-------------------------------------------------
local QuestsTab = Window:CreateTab("Quests ğŸ“œ")
QuestsTab:CreateSection("Current Quests ğŸ“Œ")
local QuestParagraphs = {}

local function updateQuestParagraph(questFolder)
    safeRun(function()
        if not questFolder then return end
        local displayName = questFolder.Name
        local name, number = displayName:match("(%a+)(%d+)")
        if name and number then displayName = name.." No."..number end

        local Requirements = questFolder:FindFirstChild("Requirements")
        local Progress = questFolder:FindFirstChild("Progress")
        if not Requirements or not Progress then return end

        local descLines = {}
        local allComplete = true
        for _, req in ipairs(Requirements:GetChildren()) do
            if req:IsA("IntValue") or req:IsA("NumberValue") then
                local prog = Progress:FindFirstChild(req.Name)
                local progVal = 0
                if prog and (prog:IsA("IntValue") or prog:IsA("NumberValue")) then progVal = prog.Value end
                local statComplete = progVal >= req.Value
                if not statComplete then allComplete=false end
                table.insert(descLines,string.format("%s/%s %s%s",abbreviateNumber(progVal),abbreviateNumber(req.Value),req.Name, statComplete and " âœ…" or ""))
            end
        end
        local descText = table.concat(descLines,"\n")
        local titleText = displayName..(allComplete and " âœ…" or "")
        if not QuestParagraphs[questFolder.Name] then
            local paragraph = QuestsTab:CreateParagraph({Title=titleText, Content=descText})
            QuestParagraphs[questFolder.Name] = paragraph
            paragraph.Completed = allComplete
        else
            local paragraph = QuestParagraphs[questFolder.Name]
            if paragraph and paragraph.Set then paragraph:Set(descText) end
            if paragraph then paragraph.Title = titleText end
            paragraph.Completed = allComplete
        end
        if allComplete then
            local paragraph = QuestParagraphs[questFolder.Name]
            if paragraph and not paragraph.Notified then
                paragraph.Notified = true
                Rayfield:Notify({
                    Title="âœ… You completed a quest!",
                    Content="You completed "..displayName.."! Stay on that grinding streak!",
                    Duration=5,
                    Image=1580567251
                })
            end
        end
    end)
end

for _, q in ipairs(QuestsFolder:GetChildren()) do updateQuestParagraph(q) end
QuestsFolder.ChildAdded:Connect(function(child) if child:IsA("Folder") then updateQuestParagraph(child) end end)

-------------------------------------------------
-- PLAYER DATA LIVE UPDATE
-------------------------------------------------
local function updatePlayerStats()
    safeRun(function()
        if OtherData:FindFirstChild("Class") then
            ClassLabel:Set("Class: "..(ClassMap[OtherData.Class.Value] or "Unknown â“"))
        end
        if OtherData:FindFirstChild("TotalPower") then
            PowerLabel:Set("Total Power: "..abbreviateNumber(OtherData.TotalPower.Value).." âš¡")
        end
        if OtherData:FindFirstChild("Yen") then
            YenLabel:Set("Money: "..abbreviateNumber(OtherData.Yen.Value).." ğŸ’°")
        end
        if OtherData:FindFirstChild("Chikara") then
            ChikaraLabel:Set("Chikara: "..abbreviateNumber(OtherData.Chikara.Value).." ğŸ’")
        end
        for statId,data in pairs(LiveStats) do
            local statObj = StatsFolder:FindFirstChild(tostring(statId))
            if statObj then
                data.Label:Set(data.StatName..": "..abbreviateNumber(statObj.Value).." "..data.Emoji)
                data.Value = statObj.Value
            end
        end
    end)
end

OtherData.ChildChanged:Connect(updatePlayerStats)
StatsFolder.ChildChanged:Connect(updatePlayerStats)

-- INITIAL CALLS
updatePlayerStats()

-------------------------------------------------
-- DONE
-------------------------------------------------
Rayfield:LoadConfiguration()
print("[MurzzHub] Fully loaded "..VERSION.." with Home tab fixed, event-based Quest Overview, and Quests tab.")
