-- Services
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Load Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

-- Window (no tab icons)
local Window = Rayfield:CreateWindow({
    Name = "Murzz Hub | AFSE",
    LoadingTitle = "Murzz Hub | AFSE",
    LoadingSubtitle = "AFSE",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

-- ========================
-- Home Tab (Stats)
-- ========================
local HomeTab = Window:CreateTab("Home") -- no icon
HomeTab:CreateSection("üìä Live Stats")

-- Number Formatter
local function formatNumber(num)
    if not num then return "Loading..." end
    num = tonumber(num)
    if not num then return "Loading..." end

    local formats = {
        {1e18, "Qn"},
        {1e15, "Qd"},
        {1e12, "T"},
        {1e9,  "B"},
        {1e6,  "M"},
        {1e3,  "K"},
    }

    for _, f in ipairs(formats) do
        if num >= f[1] then
            return string.format("%.2f%s", num / f[1], f[2]):gsub("%.00", "")
        end
    end

    return tostring(num)
end

-- Create Stat Cards
local StatCards = {}
local StatNames = { "Strength", "Durability", "Chakra", "Sword", "Agility", "Speed" }
for _, statName in ipairs(StatNames) do
    StatCards[statName] = HomeTab:CreateParagraph({
        Title = statName,
        Content = "Loading..."
    })
end

-- Stat Index Mapping
local StatMap = {
    Strength   = 1,
    Durability = 2,
    Chakra     = 3,
    Sword      = 4,
    Agility    = 5,
    Speed      = 6
}

-- Update Loop for stats
task.spawn(function()
    while true do
        local statsFolder = player:FindFirstChild("Stats")
        if statsFolder then
            for name, index in pairs(StatMap) do
                local stat = statsFolder:FindFirstChild(tostring(index))
                if stat and stat.Value ~= nil then
                    StatCards[name]:Set({
                        Title = name,
                        Content = formatNumber(stat.Value)
                    })
                else
                    StatCards[name]:Set({
                        Title = name,
                        Content = "Loading..."
                    })
                end
            end
        end
        task.wait(0.5)
    end
end)

-- ========================
-- Auto Train Tab
-- ========================
local mainClient = player:WaitForChild("PlayerGui"):WaitForChild("Main"):WaitForChild("MainClient")
local StatFunctions = require(mainClient:WaitForChild("StatFunctions"))
local CharacterModule
repeat
    CharacterModule = StatFunctions.characterModule
    task.wait(0.1)
until CharacterModule

local GameData = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("GameData"))
local tbl_upvr = {}

local AutoTrainTab = Window:CreateTab("Auto Train") -- no icon
AutoTrainTab:CreateSection("Enable Auto Training for Stats")

-- Stat toggles with compatible emojis
local statToggles = {
    {Name = "Auto Strength üí™",   ID = 1},
    {Name = "Auto Durability üõ°Ô∏è", ID = 2},
    {Name = "Auto Chakra üåÄ",     ID = 3},
    {Name = "Auto Sword ‚öîÔ∏è",      ID = 4},
    {Name = "Auto Agility üïäÔ∏è",    ID = 5}, -- more compatible wings
    {Name = "Auto Speed üí®",      ID = 6},
}

-- Create flags for toggles
for _, stat in ipairs(statToggles) do
    AutoTrainTab:CreateToggle({
        Name = stat.Name,
        CurrentValue = false,
        Flag = "AutoStat"..stat.ID,
        Callback = function() end -- loop handles it
    })
end

-- Persistent loops for auto train
for _, stat in ipairs(statToggles) do
    local flagName = "AutoStat"..stat.ID
    task.spawn(function()
        while true do
            if Rayfield.Flags[flagName] then
                if CharacterModule.states.Dead then
                    task.wait(1)
                else
                    CharacterModule.characterStopped = false
                    CharacterModule:ResumeCharacter()

                    StatFunctions.CurrentKey = stat.ID
                    StatFunctions[stat.ID] = false -- unblock cooldown

                    local success, err = pcall(function()
                        if not StatFunctions.CurrentKey or tbl_upvr[StatFunctions.CurrentKey] then return end
                        local CurrentKey = StatFunctions.CurrentKey
                        tbl_upvr[CurrentKey] = true
                        ReplicatedStorage.Remotes.RemoteEvent:FireServer("Train", CurrentKey)
                        tbl_upvr[CurrentKey] = false
                    end)

                    if not success then
                        warn("TrainStat error for statID "..stat.ID..":", err)
                    end

                    local cooldown = GameData.Stats[stat.ID].Cooldown
                    task.wait(cooldown)
                end
            else
                task.wait(0.5)
            end
        end
    end)
end

-- ========================
-- Load configuration
-- ========================
Rayfield:LoadConfiguration()
