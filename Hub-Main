-- Services
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Load Rayfield
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

-- Window
local Window = Rayfield:CreateWindow({
    Name = "Murzz Hub | AFSE",
    LoadingTitle = "Murzz Hub | AFSE",
    LoadingSubtitle = "AFSE",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

-- Home Tab
local HomeTab = Window:CreateTab("üè† Home", 4483362458)
HomeTab:CreateSection("üìä Live Stats")

-- Number Formatter
local function formatNumber(num)
    if not num then return "Loading..." end
    num = tonumber(num)
    if not num then return "Loading..." end

    local formats = {
        {1e18, "Qn"},
        {1e15, "Qd"},
        {1e12, "T"},
        {1e9,  "B"},
        {1e6,  "M"},
        {1e3,  "K"},
    }

    for _, f in ipairs(formats) do
        if num >= f[1] then
            return string.format("%.2f%s", num / f[1], f[2]):gsub("%.00", "")
        end
    end

    return tostring(num)
end

-- Create Stat Cards
local StatCards = {}
local StatNames = { "Strength", "Durability", "Chakra", "Sword", "Agility", "Speed" }
for _, statName in ipairs(StatNames) do
    StatCards[statName] = HomeTab:CreateParagraph({
        Title = statName,
        Content = "Loading..."
    })
end

-- Stat Index Mapping
local StatMap = {
    Strength   = 1,
    Durability = 2,
    Chakra     = 3,
    Sword      = 4,
    Agility    = 5,
    Speed      = 6
}

-- Update Loop
task.spawn(function()
    while true do
        local statsFolder = player:FindFirstChild("Stats")
        if statsFolder then
            for name, index in pairs(StatMap) do
                local stat = statsFolder:FindFirstChild(tostring(index))
                if stat and stat.Value ~= nil then
                    StatCards[name]:Set({
                        Title = name,
                        Content = formatNumber(stat.Value)
                    })
                else
                    StatCards[name]:Set({
                        Title = name,
                        Content = "Loading..."
                    })
                end
            end
        end
        task.wait(0.5)
    end
end)

-- ========================
-- Auto Train Tab Setup
-- ========================
local mainClient = player:WaitForChild("PlayerGui"):WaitForChild("Main"):WaitForChild("MainClient")
local StatFunctions = require(mainClient:WaitForChild("StatFunctions"))

local CharacterModule
repeat
    CharacterModule = StatFunctions.characterModule
    task.wait(0.1)
until CharacterModule

local GameData = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("GameData"))
local tbl_upvr = {}

-- Create Auto Train tab
local AutoTrainTab = Window:CreateTab("‚ö° Auto Train", 4483362458)
AutoTrainTab:CreateSection("Enable Auto Training for Stats")

-- Function to start training a specific stat (checks toggle continuously)
local function startAutoTrain(statID, flagName)
    task.spawn(function()
        while true do
            if Rayfield.Flags[flagName] then
                if CharacterModule.states.Dead then
                    task.wait(1)
                else
                    CharacterModule.characterStopped = false
                    CharacterModule:ResumeCharacter()

                    StatFunctions.CurrentKey = statID
                    StatFunctions[statID] = false -- unblock cooldown

                    local success, err = pcall(function()
                        if not StatFunctions.CurrentKey or tbl_upvr[StatFunctions.CurrentKey] then return end
                        local CurrentKey = StatFunctions.CurrentKey
                        tbl_upvr[CurrentKey] = true
                        ReplicatedStorage.Remotes.RemoteEvent:FireServer("Train", CurrentKey)
                        tbl_upvr[CurrentKey] = false
                    end)

                    if not success then
                        warn("TrainStat error for statID "..statID..":", err)
                    end

                    local cooldown = GameData.Stats[statID].Cooldown
                    task.wait(cooldown)
                end
            else
                task.wait(0.5) -- wait before checking again
            end
        end
    end)
end

-- Create toggles for each stat in Auto Train tab
local statToggles = {
    {Name = "üí™ Auto Strength",   ID = 1},
    {Name = "üõ°Ô∏è Auto Durability", ID = 2},
    {Name = "üåÄ Auto Chakra",     ID = 3},
    {Name = "‚öîÔ∏è Auto Sword",      ID = 4},
    {Name = "ü§∏ Auto Agility",    ID = 5},
    {Name = "üí® Auto Speed",      ID = 6},
}

for _, stat in ipairs(statToggles) do
    AutoTrainTab:CreateToggle({
        Name = stat.Name,
        CurrentValue = false,
        Flag = "AutoStat"..stat.ID,
        Callback = function(enabled)
            startAutoTrain(stat.ID, "AutoStat"..stat.ID)
        end
    })
end
