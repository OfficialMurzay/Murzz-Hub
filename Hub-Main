-- MurzzHub v1.0j Beta
-- NOTE: After z -> 1.01a
-- Stable build: Home, Info, Quests, Quest Overview FIXED
-- Author: Murzay

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local RunService = game:GetService("RunService")

-------------------------------------------------
-- SAFE DEBUG (ONE-TIME)
-------------------------------------------------
local warned = {}
local function warnOnce(id, msg)
	if warned[id] then return end
	warn("[MurzzHub]", msg)
	warned[id] = true
end

-------------------------------------------------
-- DATA FOLDERS (SAFE)
-------------------------------------------------
local function waitFolder(parent, name)
	local f = parent:WaitForChild(name, 5)
	if not f then
		warnOnce(name, "Missing folder: "..name)
	end
	return f
end

local OtherData = waitFolder(Player, "OtherData")
local StatsFolder = waitFolder(Player, "Stats")
local QuestsFolder = waitFolder(Player, "Quests")

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
	Name = "MurzzHub v1.0j Beta",
	LoadingTitle = "MurzzHub",
	LoadingSubtitle = "v1.0j Beta",
	ConfigurationSaving = {
		Enabled = true,
		FolderName = "MurzzHub",
		FileName = "AFSE_UI"
	},
	KeySystem = false
})

-------------------------------------------------
-- MAPS
-------------------------------------------------
local ClassMap = {
	[1]="Fighter ðŸ¥Š",[2]="Shinobi ðŸŒ€",[3]="Pirate â˜ ï¸",[4]="Ghoul ðŸ‘»",[5]="Hero ðŸ¦¸",
	[6]="Reaper â˜ ï¸",[7]="Saiyan ðŸ’¥",[8]="Sin ðŸ˜ˆ",[9]="Magi ðŸ§™",[10]="Akuma ðŸ˜¡"
}

local StatNames = {
	[1]="Strength ðŸ’ª",[2]="Durability ðŸ›¡ï¸",[3]="Chakra ðŸŒ€",
	[4]="Sword ðŸ—¡ï¸",[5]="Speed ðŸ’¨",[6]="Agility â˜ï¸"
}

-------------------------------------------------
-- UTIL
-------------------------------------------------
local function abbreviate(n)
	if not n then return "0" end
	if n >= 1e12 then return string.format("%.2fT", n/1e12)
	elseif n >= 1e9 then return string.format("%.2fB", n/1e9)
	elseif n >= 1e6 then return string.format("%.2fM", n/1e6)
	elseif n >= 1e3 then return string.format("%.2fK", n/1e3)
	else return tostring(n) end
end

-------------------------------------------------
-- INFO TAB
-------------------------------------------------
local InfoTab = Window:CreateTab("Info ðŸ› ï¸")

InfoTab:CreateSection("Update Log ðŸ“Œ")
InfoTab:CreateParagraph({
	Title = "Update Log v1.0 â€“ Release âœ…",
	Content = "Initial public release. Core UI, live stats, quests and tracking systems."
})

InfoTab:CreateSection("Discord ðŸ’¬")
InfoTab:CreateParagraph({
	Title = "Dear @"..Player.DisplayName..",",
	Content =
	"Thank you for using my script! Every use really supports me and motivates me to keep updating.\n\n" ..
	"If you want sneak peeks, events, or to suggest features, join the Discord server!\n\n" ..
	"â¤ï¸ - Murzay (Scripter)"
})

InfoTab:CreateButton({
	Name = "Join the Discord Server!",
	Callback = function()
		setclipboard("https://discord.gg/YOURSERVER")
		Rayfield:Notify({
			Title = "Discord",
			Content = "Invite copied to clipboard!",
			Duration = 4
		})
	end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home ðŸ ")
HomeTab:CreateSection("Player Data ðŸ‘¤")

local ClassLabel = HomeTab:CreateLabel("Class: ...")
local PowerLabel = HomeTab:CreateLabel("Total Power: ... âš¡")
local YenLabel = HomeTab:CreateLabel("Money: ... ðŸ’°")
local ChikaraLabel = HomeTab:CreateLabel("Chikara: ... ðŸ’Ž")

HomeTab:CreateSection("Live Stats ðŸ“Š")
local StatLabels = {}

for id, name in pairs(StatNames) do
	StatLabels[id] = HomeTab:CreateLabel(name..": ...")
end

HomeTab:CreateSection("Quest Overview ðŸ“œ")
local QuestOverview = {}

-------------------------------------------------
-- QUEST OVERVIEW LOGIC (FIXED)
-------------------------------------------------
local function formatQuestName(raw)
	local n, num = raw:match("(%a+)(%d+)")
	if n and num then
		return n.." No."..num
	end
	return raw
end

local function calculateQuestPercent(qFolder)
	local req = qFolder:FindFirstChild("Requirements")
	local prog = qFolder:FindFirstChild("Progress")
	if not req or not prog then return 0 end

	local reqTotal, progTotal = 0, 0
	for _, v in ipairs(req:GetChildren()) do
		if v:IsA("IntValue") then
			reqTotal += v.Value
		end
	end
	for _, v in ipairs(prog:GetChildren()) do
		if v:IsA("IntValue") then
			progTotal += v.Value
		end
	end

	if reqTotal == 0 then return 0 end
	return math.clamp(math.floor((progTotal / reqTotal) * 100), 0, 100)
end

local function updateQuestOverview()
	if not QuestsFolder then return end

	for _, q in ipairs(QuestsFolder:GetChildren()) do
		if q:IsA("Folder") then
			local percent = calculateQuestPercent(q)
			local name = formatQuestName(q.Name)

			if not QuestOverview[q] then
				QuestOverview[q] = HomeTab:CreateLabel(name.." ["..percent.."%]")
			else
				QuestOverview[q]:Set(name.." ["..percent.."%]")
			end
		end
	end
end

-------------------------------------------------
-- QUEST TAB
-------------------------------------------------
local QuestTab = Window:CreateTab("Quests ðŸ“œ")
QuestTab:CreateSection("Current Quests ðŸ“–")

local QuestParagraphs = {}

local function updateQuestTab()
	if not QuestsFolder then return end

	for _, q in ipairs(QuestsFolder:GetChildren()) do
		if q:IsA("Folder") then
			local lines = {}
			local completedStats = 0

			local req = q:FindFirstChild("Requirements")
			local prog = q:FindFirstChild("Progress")

			if req and prog then
				for id, statName in pairs(StatNames) do
					local r = req:FindFirstChild(tostring(id))
					local p = prog:FindFirstChild(tostring(id))
					if r and p then
						local done = p.Value >= r.Value
						if done then completedStats += 1 end
						table.insert(lines,
							abbreviate(p.Value).."/"..abbreviate(r.Value)..
							(done and " âœ…" or "")
						)
					end
				end
			end

			local title = formatQuestName(q.Name)
			if completedStats > 0 and completedStats == #lines then
				title = title.." âœ…"
			end

			if not QuestParagraphs[q] then
				QuestParagraphs[q] = QuestTab:CreateParagraph({
					Title = title,
					Content = table.concat(lines, "\n")
				})
			else
				QuestParagraphs[q]:Set({
					Title = title,
					Content = table.concat(lines, "\n")
				})
			end
		end
	end
end

-------------------------------------------------
-- LIVE UPDATES (EVENT-BASED)
-------------------------------------------------
local function updateStats()
	if OtherData then
		if OtherData:FindFirstChild("Class") then
			ClassLabel:Set("Class: "..(ClassMap[OtherData.Class.Value] or "Unknown"))
		end
		if OtherData:FindFirstChild("TotalPower") then
			PowerLabel:Set("Total Power: "..abbreviate(OtherData.TotalPower.Value).." âš¡")
		end
		if OtherData:FindFirstChild("Yen") then
			YenLabel:Set("Money: "..abbreviate(OtherData.Yen.Value).." ðŸ’°")
		end
		if OtherData:FindFirstChild("Chikara") then
			ChikaraLabel:Set("Chikara: "..abbreviate(OtherData.Chikara.Value).." ðŸ’Ž")
		end
	end

	if StatsFolder then
		for id, lbl in pairs(StatLabels) do
			local v = StatsFolder:FindFirstChild(tostring(id))
			if v then
				lbl:Set(StatNames[id]..": "..abbreviate(v.Value))
			end
		end
	end
end

-------------------------------------------------
-- CONNECTIONS
-------------------------------------------------
updateStats()
updateQuestOverview()
updateQuestTab()

if OtherData then
	OtherData.ChildAdded:Connect(updateStats)
end
if StatsFolder then
	StatsFolder.ChildAdded:Connect(updateStats)
end
if QuestsFolder then
	QuestsFolder.ChildAdded:Connect(function()
		updateQuestOverview()
		updateQuestTab()
	end)
end

print("[MurzzHub] v1.0j Beta loaded successfully.")
