-- MurzzHub v1.0r Beta
-- Full Stable Build (Home + Live Stats + Quests + Auto Train)
-- Author: Murzay | Animated Numbers + Auto Train Logic

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local OtherData = Player:WaitForChild("OtherData")
local StatsFolder = Player:WaitForChild("Stats")
local QuestsFolder = Player:WaitForChild("Quests")

-------------------------------------------------
-- VERSION
-------------------------------------------------
local VERSION = "v1.0r Beta"

-------------------------------------------------
-- SAFE DEBUG
-------------------------------------------------
local warned = false
local function safeRun(fn)
    local ok, err = pcall(fn)
    if not ok and not warned then
        warned = true
        warn("[MurzzHub Debug] "..err)
    end
end

local function log(msg)
    print("[MurzzHub DEBUG] "..tostring(msg))
end

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "MurzzHub "..VERSION,
    LoadingTitle = "MurzzHub "..VERSION,
    LoadingSubtitle = "Stable Live Player Data & Quests",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "MurzzHub",
        FileName = "AFSE_UI"
    }
})

-------------------------------------------------
-- UTIL (FIXED ABBREVIATION)
-------------------------------------------------
local function abbreviate(n)
    if n >= 1e18 then
        return string.format("%.2fQn", n/1e18)
    elseif n >= 1e15 then
        return string.format("%.2fQd", n/1e15)
    elseif n >= 1e12 then
        return string.format("%.2fT", n/1e12)
    elseif n >= 1e9 then
        return string.format("%.2fB", n/1e9)
    elseif n >= 1e6 then
        return string.format("%.2fM", n/1e6)
    elseif n >= 1e3 then
        return string.format("%.2fK", n/1e3)
    else
        return tostring(n)
    end
end

local function easeOutQuad(t)
    return 1 - (1 - t)^2
end

local function animateNumber(label, startValue, endValue, prefix, emoji, duration)
    duration = duration or 0.5
    local fps = 60
    local steps = math.max(1, math.floor(duration * fps))
    for i = 1, steps do
        local t = easeOutQuad(i/steps)
        local val = startValue + (endValue - startValue) * t
        label:Set(prefix..abbreviate(math.floor(val)).." "..emoji)
        task.wait(duration/steps)
    end
    label:Set(prefix..abbreviate(endValue).." "..emoji)
end

-------------------------------------------------
-- MAPS
-------------------------------------------------
local ClassMap = {
    [1]="Fighter ü•ä",[2]="Shinobi üåÄ",[3]="Pirate ‚ò†Ô∏è",[4]="Ghoul üëª",[5]="Hero ü¶∏",
    [6]="Reaper ‚ò†Ô∏è",[7]="Saiyan üí•",[8]="Sin üòà",[9]="Magi üßô",[10]="Akuma üò°",
    [11]="Yonko üè¥‚Äç‚ò†Ô∏è",[12]="Gorosei üßì",[13]="Overlord üëë",[14]="Hokage ü¶ä",
    [15]="Kaioshin üëº",[16]="Sage üïäÔ∏è",[17]="Espada ‚öîÔ∏è",[18]="Shinigami üëπ",
    [19]="Hashira ‚öîÔ∏è",[20]="Hakaishin üíÄ",[21]="Otsutsuki üåå",
    [22]="Pirate King üè¥‚Äç‚ò†Ô∏èüëë",[23]="Kishin üëø",[24]="Angel üòá",
    [25]="Demon King üëπ",[26]="Ultra Instinct ‚ú®",[27]="Upper Moon üåô"
}

local StatMap = {
    ["1"]={"Strength","üí™"},
    ["2"]={"Durability","üõ°Ô∏è"},
    ["3"]={"Chakra","üåÄ"},
    ["4"]={"Sword","üó°Ô∏è"},
    ["5"]={"Speed","üí®"},
    ["6"]={"Agility","‚òÅÔ∏è"},
    ["Kill"]={"Kill","üî™"},
}

-------------------------------------------------
-- INFO TAB
-------------------------------------------------
local InfoTab = Window:CreateTab("Info üõ†Ô∏è")

InfoTab:CreateSection("Update Log üìù")
InfoTab:CreateParagraph({
    Title = VERSION,
    Content = [[
‚Ä¢ Quests Tab added
‚Ä¢ Live % tracking per quest
‚Ä¢ Emojis standardized (right-side)
‚Ä¢ Kill quests fully supported
‚Ä¢ Event-based (zero loops)
‚Ä¢ UI locked & stable
‚Ä¢ Home + Live Stats + Quest Progress animate incrementally with easing
‚Ä¢ Auto Train UI + functional toggles that trigger on cooldown
]]
})

InfoTab:CreateSection("Discord üí¨")
InfoTab:CreateParagraph({
    Title = "Dear @"..Player.DisplayName,
    Content = [[
Thank you for using MurzzHub ‚ù§Ô∏è  
Every use motivates future updates!

Suggestions, sneak peeks & events:
]]
})

InfoTab:CreateButton({
    Name = "Join Discord",
    Callback = function()
        setclipboard("DISCORD_LINK_HERE")
    end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home üè†")

HomeTab:CreateSection("Player Data üë§")

local ClassLabel = HomeTab:CreateLabel("Class: ...")
local PowerLabel = HomeTab:CreateLabel("Total Power: ... ‚ö°")
local YenLabel = HomeTab:CreateLabel("Money: ... üí∞")
local ChikaraLabel = HomeTab:CreateLabel("Chikara: ... üíé")

local function bindValue(obj, label, prefix, emoji)
    if not obj then return end
    local current = obj.Value
    local function update()
        local newVal = obj.Value
        task.spawn(function()
            animateNumber(label, current, newVal, prefix, emoji, 0.7)
            current = newVal
        end)
    end
    update()
    obj:GetPropertyChangedSignal("Value"):Connect(update)
end

bindValue(OtherData:FindFirstChild("TotalPower"), PowerLabel, "Total Power: ", "‚ö°")
bindValue(OtherData:FindFirstChild("Yen"), YenLabel, "Money: ", "üí∞")
bindValue(OtherData:FindFirstChild("Chikara"), ChikaraLabel, "Chikara: ", "üíé")

if OtherData:FindFirstChild("Class") then
    local function update()
        ClassLabel:Set("Class: "..(ClassMap[OtherData.Class.Value] or "Unknown ‚ùì"))
    end
    update()
    OtherData.Class:GetPropertyChangedSignal("Value"):Connect(update)
end

-------------------------------------------------
-- LIVE STATS
-------------------------------------------------
HomeTab:CreateSection("Live Stats üìä")

for id,data in pairs(StatMap) do
    if tonumber(id) then
        local name, emoji = unpack(data)
        local label = HomeTab:CreateLabel(name..": ... "..emoji)
        local stat = StatsFolder:FindFirstChild(id)
        if stat then
            local current = stat.Value
            local function update()
                local newVal = stat.Value
                task.spawn(function()
                    animateNumber(label, current, newVal, name..": ", emoji, 0.7)
                    current = newVal
                end)
            end
            update()
            stat:GetPropertyChangedSignal("Value"):Connect(update)
        end
    end
end

-------------------------------------------------
-- QUESTS TAB
-------------------------------------------------
local QuestsTab = Window:CreateTab("Quests üìú")

local function setupQuest(quest)
    safeRun(function()
        local display = quest.Name:gsub("(%a+)(%d+)", "%1 No.%2")
        QuestsTab:CreateSection(display.." üìú")

        local reqs = quest:FindFirstChild("Requirements")
        if not reqs then return end

        for _,req in ipairs(reqs:GetChildren()) do
            if req:IsA("IntValue") or req:IsA("NumberValue") then
                local label = QuestsTab:CreateLabel("...")

                local current = 0
                local function update()
                    local progress = 0
                    if quest:FindFirstChild(req.Name) then
                        progress = quest[req.Name].Value
                    elseif quest:FindFirstChild("Progress")
                        and quest.Progress:FindFirstChild(req.Name) then
                        progress = quest.Progress[req.Name].Value
                    end

                    local name, emoji = req.Name, ""
                    if StatMap[req.Name] then
                        name, emoji = unpack(StatMap[req.Name])
                    end

                    local done = progress >= req.Value

                    task.spawn(function()
                        local steps = 30
                        local duration = 0.7
                        for i = 1, steps do
                            local t = easeOutQuad(i/steps)
                            local val = current + (progress - current) * t
                            label:Set(string.format("%s/%s %s %s%s",
                                abbreviate(math.floor(val)),
                                abbreviate(req.Value),
                                name,
                                emoji,
                                done and " ‚úÖ" or ""
                            ))
                            task.wait(duration/steps)
                        end
                        label:Set(string.format("%s/%s %s %s%s",
                            abbreviate(progress),
                            abbreviate(req.Value),
                            name,
                            emoji,
                            done and " ‚úÖ" or ""
                        ))
                        current = progress
                    end)
                end

                update()

                if quest:FindFirstChild(req.Name) then
                    quest[req.Name]:GetPropertyChangedSignal("Value"):Connect(update)
                end
                if quest:FindFirstChild("Progress")
                    and quest.Progress:FindFirstChild(req.Name) then
                    quest.Progress[req.Name]:GetPropertyChangedSignal("Value"):Connect(update)
                end
            end
        end
    end)
end

for _,q in ipairs(QuestsFolder:GetChildren()) do
    if q:IsA("Folder") then setupQuest(q) end
end

-------------------------------------------------
-- AUTO FARMS TAB (IMPROVED COOLDOWN)
-------------------------------------------------
local AutoTab = Window:CreateTab("Auto Farms ‚öôÔ∏è")
AutoTab:CreateSection("Auto Train üèãÔ∏è")

local mainClient = Player:WaitForChild("PlayerGui"):WaitForChild("Main"):WaitForChild("MainClient")
local StatFunctions = require(mainClient:WaitForChild("StatFunctions"))
local CharacterModule
repeat
    CharacterModule = StatFunctions.characterModule
    task.wait(0.1)
until CharacterModule

local GameData = require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("GameData"))

local AutoStats = {
    {1, "Strength", "üí™"},
    {2, "Durability", "üõ°Ô∏è"},
    {3, "Chakra", "üåÄ"},
    {4, "Sword", "üó°Ô∏è"},
    {5, "Agility", "‚òÅÔ∏è"},
    {6, "Speed", "üí®"},
}

local AutoToggles = {}
local ActiveTrains = {}

for _,stat in ipairs(AutoStats) do
    local statID, name, emoji = unpack(stat)
    local toggle = AutoTab:CreateToggle({
        Name = "Train "..name.." "..emoji,
        CurrentValue = false,
        Flag = name.."Toggle",
        Callback = function(val)
            if val then
                if ActiveTrains[statID] then return end
                ActiveTrains[statID] = true
                task.spawn(function()
                    while ActiveTrains[statID] do
                        if CharacterModule.states.Dead then
                            task.wait(1)
                        else
                            CharacterModule.characterStopped = false
                            CharacterModule:ResumeCharacter()
                            StatFunctions.CurrentKey = statID
                            StatFunctions[statID] = false

                            local cooldown = GameData.Stats[statID].Cooldown or 0.1
                            local fired = false
                            local start = tick()

                            while tick() - start < cooldown do
                                task.wait(0.05) -- small interval to check
                            end

                            local success, err = pcall(function()
                                ReplicatedStorage.Remotes.RemoteEvent:FireServer("Train", statID)
                            end)
                            if success then
                                log("TrainStat fired for "..name)
                            else
                                log("TrainStat error: "..tostring(err))
                            end
                        end
                    end
                    ActiveTrains[statID] = nil
                end)
            else
                ActiveTrains[statID] = false
            end
        end
    })
    table.insert(AutoToggles, toggle)
end

-------------------------------------------------
-- DONE
-------------------------------------------------
Rayfield:LoadConfiguration()
print("[MurzzHub] "..VERSION.." loaded successfully")
