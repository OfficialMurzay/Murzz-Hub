-- MurzzHub v1.0j Beta
-- UI + Player Data + Live Stats + Info + Quests
-- FULL FIXED VERSION (No nil errors)
-- Author: Murzay

-------------------------------------------------
-- SERVICES
-------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
local OtherData = Player:WaitForChild("OtherData")
local StatsFolder = Player:WaitForChild("Stats")
local QuestsFolder = Player:WaitForChild("Quests")

-------------------------------------------------
-- RAYFIELD
-------------------------------------------------
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local VERSION = "v1.0j Beta"

local Window = Rayfield:CreateWindow({
    Name = "MurzzHub "..VERSION,
    LoadingTitle = "MurzzHub "..VERSION,
    LoadingSubtitle = VERSION.." - UI Live Player Data, Stats & Quests",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "MurzzHub",
        FileName = "AFSE_UI"
    },
    KeySystem = false
})

-------------------------------------------------
-- CLASS MAP
-------------------------------------------------
local ClassMap = {
    [1]="Fighter ü•ä",[2]="Shinobi üåÄ",[3]="Pirate ‚ò†Ô∏è",[4]="Ghoul üëª",[5]="Hero ü¶∏",
    [6]="Reaper ‚ò†Ô∏è",[7]="Saiyan üí•",[8]="Sin üòà",[9]="Magi üßô",[10]="Akuma üò°",
    [11]="Yonko üè¥‚Äç‚ò†Ô∏è",[12]="Gorosei üßì",[13]="Overlord üëë",[14]="Hokage ü¶ä",
    [15]="Kaioshin üëº",[16]="Sage üïäÔ∏è",[17]="Espada ‚öîÔ∏è",[18]="Shinigami üëπ",
    [19]="Hashira ‚öîÔ∏è",[20]="Hakaishin üíÄ",[21]="Otsutsuki üåå",
    [22]="Pirate King üè¥‚Äç‚ò†Ô∏èüëë",[23]="Kishin üëø",[24]="Angel üòá",
    [25]="Demon King üëπ",[26]="Ultra Instinct ‚ú®",[27]="Upper Moon üåô"
}

-------------------------------------------------
-- STAT MAP
-------------------------------------------------
local StatIdToName = {
    [1]="Strength üí™",[2]="Durability üõ°Ô∏è",[3]="Chakra üåÄ",
    [4]="Sword üó°Ô∏è",[5]="Speed üí®",[6]="Agility ‚òÅÔ∏è"
}

-------------------------------------------------
-- UTIL
-------------------------------------------------
local function abbreviateNumber(num)
    if not num then return "0" end
    local abs = math.abs(num)
    if abs >= 1e12 then return string.format("%.2fT", num/1e12)
    elseif abs >= 1e9 then return string.format("%.2fB", num/1e9)
    elseif abs >= 1e6 then return string.format("%.2fM", num/1e6)
    elseif abs >= 1e3 then return string.format("%.2fK", num/1e3)
    else return tostring(num) end
end

-------------------------------------------------
-- INFO TAB
-------------------------------------------------
local InfoTab = Window:CreateTab("Info üõ†Ô∏è")

InfoTab:CreateSection("Update Log üìù")
InfoTab:CreateParagraph({
    Title = "Update Log "..VERSION,
    Content = "Quest overview fixed.\nNil indexing eliminated.\nLive AFSE-safe UI."
})

InfoTab:CreateSection("Discord üí¨")
InfoTab:CreateParagraph({
    Title = "Dear @"..Player.DisplayName,
    Content =
        "Thank you for using MurzzHub!\n\n"..
        "Join the Discord for updates, previews and events.\n\n"..
        "‚ù§Ô∏è - Murzay"
})

InfoTab:CreateButton({
    Name = "Copy Discord Invite",
    Callback = function()
        setclipboard("DISCORD_LINK_HERE")
    end
})

-------------------------------------------------
-- HOME TAB
-------------------------------------------------
local HomeTab = Window:CreateTab("Home üè†")

HomeTab:CreateSection("Player Data üë§")
local ClassLabel   = HomeTab:CreateLabel("Class: ...")
local PowerLabel   = HomeTab:CreateLabel("Total Power: ... ‚ö°")
local YenLabel     = HomeTab:CreateLabel("Money: ... üí∞")
local ChikaraLabel = HomeTab:CreateLabel("Chikara: ... üíé")

-------------------------------------------------
-- LIVE STATS
-------------------------------------------------
HomeTab:CreateSection("Live Stats üìä")
local LiveStats = {}

for id, name in pairs(StatIdToName) do
    local stat, emoji = name:match("^(.-) (.+)$")
    LiveStats[id] = {
        Label = HomeTab:CreateLabel(stat..": ... "..emoji),
        StatName = stat,
        Emoji = emoji
    }
end

-------------------------------------------------
-- QUEST OVERVIEW (FULLY SAFE)
-------------------------------------------------
HomeTab:CreateSection("Quest Overview üìú")
local QuestLabels = {}

local function formatQuestName(name)
    local a,b = name:match("(%a+)(%d+)")
    return a and b and (a.." No."..b) or name
end

local function computeQuestPercent(q)
    local req = q:FindFirstChild("Requirements")
    local prog = q:FindFirstChild("Progress")
    if not req or not prog then return 0,false end

    local totalReq,totalProg = 0,0
    local done = true

    for _,r in ipairs(req:GetChildren()) do
        if r:IsA("IntValue") then
            totalReq += r.Value
            local p = prog:FindFirstChild(r.Name)
            local pv = (p and p:IsA("IntValue")) and p.Value or 0
            totalProg += pv
            if pv < r.Value then done = false end
        end
    end

    local percent = totalReq > 0 and math.floor((totalProg/totalReq)*100) or 0
    return percent,done
end

local function updateQuest(q)
    local percent,done = computeQuestPercent(q)
    local text = formatQuestName(q.Name).." ["..percent.."%]"..(done and " ‚úÖ" or "")

    if not QuestLabels[q] then
        QuestLabels[q] = HomeTab:CreateLabel(text)
    else
        QuestLabels[q].Text = text
    end
end

local function hookQuest(q)
    if not q:IsA("Folder") then return end
    updateQuest(q)

    task.spawn(function()
        local prog = q:WaitForChild("Progress",10)
        if not prog then return end

        prog.ChildAdded:Connect(function() updateQuest(q) end)
        prog.ChildRemoved:Connect(function() updateQuest(q) end)

        for _,v in ipairs(prog:GetChildren()) do
            if v:IsA("IntValue") then
                v.Changed:Connect(function()
                    updateQuest(q)
                end)
            end
        end
    end)
end

for _,q in ipairs(QuestsFolder:GetChildren()) do
    hookQuest(q)
end

QuestsFolder.ChildAdded:Connect(hookQuest)

-------------------------------------------------
-- QUESTS TAB (STATIC DETAILS)
-------------------------------------------------
local QuestsTab = Window:CreateTab("Quests üìú")
QuestsTab:CreateSection("Current Quests üìå")

for _,q in ipairs(QuestsFolder:GetChildren()) do
    local req = q:FindFirstChild("Requirements")
    local prog = q:FindFirstChild("Progress")
    local lines = {}

    if req and prog then
        for _,r in ipairs(req:GetChildren()) do
            if r:IsA("IntValue") then
                local p = prog:FindFirstChild(r.Name)
                local pv = p and p.Value or 0
                table.insert(lines,
                    abbreviateNumber(pv).."/"..abbreviateNumber(r.Value).." "..r.Name
                )
            end
        end
    end

    QuestsTab:CreateParagraph({
        Title = q.Name,
        Content = table.concat(lines,"\n")
    })
end

-------------------------------------------------
-- LIVE UPDATES
-------------------------------------------------
RunService.Heartbeat:Connect(function()
    if OtherData:FindFirstChild("Class") then
        ClassLabel.Text = "Class: "..(ClassMap[OtherData.Class.Value] or "Unknown ‚ùì")
    end
    if OtherData:FindFirstChild("TotalPower") then
        PowerLabel.Text = "Total Power: "..abbreviateNumber(OtherData.TotalPower.Value).." ‚ö°"
    end
    if OtherData:FindFirstChild("Yen") then
        YenLabel.Text = "Money: "..abbreviateNumber(OtherData.Yen.Value).." üí∞"
    end
    if OtherData:FindFirstChild("Chikara") then
        ChikaraLabel.Text = "Chikara: "..abbreviateNumber(OtherData.Chikara.Value).." üíé"
    end

    for id,data in pairs(LiveStats) do
        local stat = StatsFolder:FindFirstChild(tostring(id))
        if stat then
            data.Label.Text = data.StatName..": "..abbreviateNumber(stat.Value).." "..data.Emoji
        end
    end
end)

-------------------------------------------------
-- DONE
-------------------------------------------------
Rayfield:LoadConfiguration()
print("[MurzzHub] "..VERSION.." loaded successfully")
